<link rel="import" href="../polymer/polymer.html">

<!--
`<global-variable>`
[Polymer](https://www.polymer-project.org/1.0/) element that allows share data between non-relatives elements.

You can instance this element as many times as you desire.
Every time that an instance's `value` is modified, it will be propagated to the rest of the
instances of this element with the same `key`.
 ```html
  <global-variable key="input"
                   value="{{ inputElement1 }}"></global-variable>
  <paper-input label="Element 1"
               value="{{ inputElement1 }}"></paper-input>

  <global-variable key="input"
                   value="{{ inputElement2 }}"></global-variable>
  <paper-input label="Element 2"
               value="{{ inputElement2 }}"></paper-input>
```
Both input will show the same value

@demo demo/index.html 
-->

<dom-module id="global-variable">
  <template>
    <style>
      :host {
        display: none;
      }
    </style>

  </template>
  <script>
      (function(){
          // Shared information:
          // data =  key:{ value:"", subscribers:[] } }
          // Each key has a record of the elements which are subscribed to its value
          var data = {};

          Polymer({
              is: 'global-variable',
              properties: {
                  /** Key to subscribe */
                  key: {
                      type: String,
                      reflectToAttribute: true,
                      observer: '_subscribe'
                  },

                  /** Current value of the element. If the element is subscribed to a key, this param is as well,
                   * the current value for the key */
                  value: {
                      notify: true,
                      reflectToAttribute: true
                  },

                  /** Readonly elements, will not propagate any possible value change to the rest of the subscribers */
                  readonly: {
                      type: Boolean,
                      value: false,
                      reflectToAttribute: true
                  }
              },

              observers: [
                  '_updateOrigin(key, value, readonly)'
              ],


              _isSubscribed: function(){
                  return this.key != '' && data[this.key].subscriber.indexOf(this) != -1;
              },

              detached: function() {
                  if (this._isSubscribed(this.key)) this._unsubscribe(this.key);
              },

              _set: function(key, value){
                  this.set(key, value);
              },

              _updateOrigin: function(key, value, readonly){
                  if(!readonly && data[key].value != value) {
                      data[key].value = value;
                      //Propagating changes
                      data[key].subscribers.forEach(function(element){
                          element._set('value', value);
                      });
                  }
              },

              _subscribe: function(newKey, oldKey){
                  if(newKey != oldKey && oldKey) this._unsubscribe(oldKey);

                  if(data[newKey]) {
                      data[newKey].subscribers.push(this);
                      if(this.value != data[newKey].value)
                          this.set('value', data[newKey].value);
                  } else {
                      data[newKey] = {
                          value: this.value,
                          subscribers: [this]
                      };
                  }
              },

              _unsubscribe: function(key){
                  var subscribers = data[key].subscribers;
                  var index = subscribers.indexOf(this);
                  if(index >= 0) subscribers.splice(index, 1);
                  if(subscribers.length == 0) delete data[key];
              }
          });
      })()
  </script>
</dom-module>
